# MSC
## Overview
This projects is used to deploy OpenShift on MSC's infrastructure

Andremo a creare i seguenti nodi per l'infrastruttura OCP:
- bootstrap: verrà eliminato alla fine dell'installazione
- master (3 nodes)
- ocs (3 nodes)
- router (2 nodes): ergo support-nodes, nginx dell'Ingress Controller   
- infra (3 nodes): EFK stack
- compute (4 nodes): workers
- maintenance: bastion host

## Prerequisites
Ensure to have the following components installed (Be carfull on the version
stated).

* python 3
* pip:
  * pyVim
  * pyVmomi
  * openshift 0.11.2
  * ansible v2.9.15
* gopass (Password store)
* summon
## Setup

```
yum install python3 python3-pip
yum install -y https://github.com/gopasspw/gopass/releases/download/v1.9.2/gopass_1.9.2_linux_amd64.rpm
yum install -y https://github.com/cyberark/summon/releases/download/v0.8.3/summon_0.8.3_amd64.rpm
gopass clone --sync gitcli https://gitlab.devops.msccruises.com/openshift/msc-gopass.git msc-gopass
mkdir /usr/local/lib/summon
ln -s /usr/local/bin/gopass /usr/local/lib/summon/gopass
pip3 install ansible==2.9.15 kubernetes openshift PyVim PyVmomi openshift=0.11.2
echo "alias ansible-playbook='python3 $(which ansible-playbook)'" >> ~/.bashrc
source ~/.bashrc
```
The playbooks are based on Camptocamp public roles

```
ansible-galaxy install -r roles/requirements.yml --roles-path roles
```

# Setup of the installer
In UPI mode, the ignition file must be generated by the installer on the bastion host
## Inventory
In folder inventory/<environment>/hosts, edit the necessary values according to
your installation
## Generate the ignition
Genera dei files necessari all'installazione, essi dureranno 24 ore. Il path (/ocp/prod) è generato con le variabili all'interno del file inventory hosts.
```
summon ansible-playbook playbooks/install_bastion.yml -i inventory/<inventory_name>
```
Note: If the ignition files already exist, the generation of the ignition files
will be skipped. You can delete the folder located in /ocp/<environment>

```
# cd /ocp/prod
# ls -ltr
total 332
-rw-r-----. 1 root root   1833 Nov 30 10:03 master.ign
-rw-r-----. 1 root root   1833 Nov 30 10:03 worker.ign
-rw-r-----. 1 root root 309008 Nov 30 10:03 bootstrap.ign
-rw-r-----. 1 root root    232 Nov 30 10:03 metadata.json
-rw-r--r--. 1 root root    322 Nov 30 10:03 append-bootstrap.ign
-rw-r--r--. 1 root root   2444 Nov 30 10:03 master.64
-rw-r--r--. 1 root root   2444 Nov 30 10:03 worker.64
-rw-r--r--. 1 root root    432 Nov 30 10:03 append-bootstrap.64
drwxr-x---. 2 root root     50 Nov 30 10:45 auth
#
```

# Provisioning
In UPI mode (User Provisioned Infrastructure), the user is responsible to
provision a large set of machines in prior to get OpenShift installed

## Bootstrap
The boostreap machine is ephemeral and is used only for the setup phase.
```
summon ansible-playbook playbooks/provision_bootstrap.yml -i inventory/<inventory_name>
```
## Masters
```
summon ansible-playbook playbooks/provision_masters.yml -i inventory/<inventory_name>
```
## Nodes
```
summon ansible-playbook playbooks/provision_nodes.yml -i inventory/<inventory_name>
```
Nota: è possibile eseguire il provision dei singoli pool dei nodi attraverso l'opzione --limit:
```
summon ansible-playbook playbooks/provision_nodes.yml -i inventory/production/ --limit workers,supports
```
Dopo aver lanciato il playbook, verificare dal bastion host i certificati e apporovarli.
Verificare anche tutti i cluster operators (devono essere tutti online correttamente).
```
$ export KUBECONFIG=/ocp/prod/auth/kubeconfig
$ oc get csr -o name | xargs oc adm certificate approve
$ oc get clusteroperators
```

# Post installation
### Configure Ingress (nginx)
```
summon ansible-playbook playbooks/configure-ingress.yml -i inventory/production/
```
Da ora si può eseguire la login alla console web. In caso di problemi, verificare la corretta comunicazione tra i bilanciatori e i support nodes (dove su questi ultimi girano appunto i pod nginx).

## Configure oauth
```
ansible-playbook playbooks/configure-oauth.yml -i inventory/<inventory_name>
```
```
# oc get groups
NAME               USERS
MSC-DEVOPS-ADMIN   acastagn, derosama, marborio, mbuccoliero, mespertini, ggrosso, gmaiocchi, mmonzeglio, gorru, mpaglino, rpalugan, asperanza, etosi, fgia        naro, pgarzotto, vjunuzovic, pdauria, aalice, dpirola, cgiordani, dpettisani, lkulyk, foldoni, adolci, mtorrisi, prassu, ppozzo, sa_ltrevisan, ffazzari, du        rso, lbonanomi, dchathoth, amorlacchi, cregazzoni, rquintini, mcanevet, ysoubeyrand, mlaager, mbornoz, dabelenda, pburgisser, dquadrini, sgraziano, fdefili        ppo, lorlandi, jraccuglia, rrizzi, ylemrozi, adesantis, mavalente, afavati, adipascale, clamantia, sraccuglia, gguzzone, gasavoca, rsavaia, avaltorta, gipi        sani, flagana, mmilesi
#
```

## Configure workers
```
# summon ansible-playbook playbooks/configure-workers.yml -i inventory/production/
```
Questo playbook permette ai soli worker node (tramite apposite label "type=worker") si essere gli unici nodi a porter ospitare i pod.


## Configure OCS
```
ansible-playbook playbooks/configure-ocs.yml -i inventory/<inventory_name>
```
A seguito del lancio del playbook, eseguire dalla web console, su namespace openshift-storage:
- andare in Operator -> Installa Operator
- aspettare che i pod siano running e ready
- entrare nell'operator appena installato -> All Instances -> Create New Storage Cluster (Internal - seleziona i 3 nodi sotarge - poi seleziona Storage Class: thin)
- aspettare che tutti i pod vengano su (tempo stimato 30-40 minuti)


## Configure monitoring
```
ansible-playbook playbooks/configure-monitoring.yml -i inventory/<inventory_name>
```
for LAB, add the argument below to not deploy the logging stack

```
--skip-tags logging-cr
```

- nel project openshift-monitoring verificare che sia stato installato il cluster operator relativo al monitoraggio
- verificare anche la creazione dei 3 PVC (3 infra-nodes)
- verificare da web console che i grafici nella sezione Overview siano popolati (prometheus)

## Configure Registry
```
summon ansible-playbook playbooks/configure-registry.yml -i inventory/production/
```

## Configure networking
```
ansible-playbook playbooks/configure-networking.yml -i inventory/<inventory_name>
```

## Configure MCO
```
ansible-playbook playbooks/configure-mco.yml -i inventory/<inventory_name>
```
